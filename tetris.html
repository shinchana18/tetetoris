<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">
<title>Tetris</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#container {
  display: grid;
  grid-template-columns: 1fr 120px;
  height: 100%;
}

canvas {
  background: #111;
  width: 100%;
  height: 100%;
}

#side {
  color: white;
  font-family: monospace;
  padding: 8px;
  box-sizing: border-box;
}

#ui {
  position: absolute;
  bottom: 10px;
  left: 0;
  right: 120px;
  display: flex;
  justify-content: space-around;
}

button {
  font-size: 16px;
  padding: 12px;
}
</style>
</head>

<body>
<div id="container">
  <canvas id="game"></canvas>

  <div id="side">
    <div>SCORE</div>
    <div id="score">0</div>
    <br>
    <div>LEVEL</div>
    <div id="level">0</div>
    <br>
    <div>NEXT</div>
    <canvas id="next" width="80" height="80"></canvas>
    <br>
    <button id="pause">PAUSE</button>
  </div>
</div>

<div id="ui">
  <button id="left">◀</button>
  <button id="rotate">⟳</button>
  <button id="right">▶</button>
  <button id="drop">▼</button>
</div>

<script>
const COLS = 10, ROWS = 20;
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener("resize", resize);
resize();

const BLOCK = canvas.height / ROWS;

const COLORS = [null,"#0ff","#00f","#f80","#ff0","#0f0","#f00","#a0f"];
const SHAPES = [
  [],
  [[1,1,1,1]],
  [[2,0,0],[2,2,2]],
  [[0,0,3],[3,3,3]],
  [[4,4],[4,4]],
  [[0,5,5],[5,5,0]],
  [[0,6,0],[6,6,6]],
  [[7,7,0],[0,7,7]]
];

let board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
let score = 0, lines = 0, level = 0;
let paused = false;

function newPiece() {
  const t = Math.floor(Math.random()*7)+1;
  return {x:3,y:0,shape:SHAPES[t],type:t};
}

let piece = newPiece();
let nextPiece = newPiece();

function collide(p, ox, oy) {
  for (let y=0;y<p.shape.length;y++)
    for (let x=0;x<p.shape[y].length;x++)
      if (p.shape[y][x]) {
        let nx=p.x+x+ox, ny=p.y+y+oy;
        if (nx<0||nx>=COLS||ny>=ROWS||board[ny]?.[nx]) return true;
      }
  return false;
}

function rotate(mat) {
  return mat[0].map((_,i)=>mat.map(r=>r[i]).reverse());
}

function merge() {
  piece.shape.forEach((r,y)=>r.forEach((v,x)=>{
    if(v) board[piece.y+y][piece.x+x]=piece.type;
  }));
}

function clearLines() {
  let cleared = 0;
  board = board.filter(r=>{
    if(r.every(v=>v)){cleared++; return false;}
    return true;
  });
  while(board.length<ROWS) board.unshift(Array(COLS).fill(0));

  if(cleared){
    const table=[0,40,100,300,1200];
    score += table[cleared]*(level+1);
    lines += cleared;
    level = Math.floor(lines/10);
    document.getElementById("score").textContent=score;
    document.getElementById("level").textContent=level;
  }
}

let dropCounter=0,last=0;
function update(t=0){
  if(paused){requestAnimationFrame(update);return;}
  const d=t-last; last=t; dropCounter+=d;
  if(dropCounter>700-Math.min(level*50,500)){
    if(!collide(piece,0,1)) piece.y++;
    else{
      merge(); clearLines();
      piece=nextPiece;
      nextPiece=newPiece();
      drawNext();
    }
    dropCounter=0;
  }
  draw(); requestAnimationFrame(update);
}

function drawBlock(x,y,c){
  ctx.fillStyle=c;
  ctx.fillRect(x*BLOCK,y*BLOCK,BLOCK-1,BLOCK-1);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  board.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(x,y,COLORS[v])));
  piece.shape.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(piece.x+x,piece.y+y,COLORS[piece.type])));
}

function drawNext(){
  const n=document.getElementById("next").getContext("2d");
  n.clearRect(0,0,80,80);
  nextPiece.shape.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){
      n.fillStyle=COLORS[nextPiece.type];
      n.fillRect(x*20,y*20,18,18);
    }
  }));
}

document.getElementById("left").onclick=()=>!collide(piece,-1,0)&&(piece.x--);
document.getElementById("right").onclick=()=>!collide(piece,1,0)&&(piece.x++);
document.getElementById("rotate").onclick=()=>{
  const r=rotate(piece.shape);
  if(!collide({...piece,shape:r},0,0)) piece.shape=r;
};
document.getElementById("drop").onclick=()=>{
  while(!collide(piece,0,1)) piece.y++;
};
document.getElementById("pause").onclick=()=>{
  paused=!paused;
};

drawNext();
update();
</script>
</body>
</html>
